<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AmazeHeads Admin â€“ Upload Dashboard</title>

  <link rel="stylesheet" href="styles.css" />

  <style>
    /* --- DRAG & DROP UPLOAD ZONE --- */
    #dropZone {
      border: 2px dashed #4a90e2;
      padding: 25px;
      text-align: center;
      border-radius: 12px;
      color: #4a90e2;
      font-weight: bold;
      margin-bottom: 12px;
      transition: background-color 0.3s, border-color 0.3s;
    }
    #dropZone.dragover {
      background-color: #e8f3ff;
      border-color: #1c72d8;
    }

    /* --- NEW MEDIA GRID --- */
    #mediaList {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 18px;
    }

    .card {
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 3px 12px rgba(0,0,0,0.1);
      transition: 0.2s;
      position: relative;
    }
    .card:hover {
      transform: scale(1.03);
    }
    .card img, .card video {
      width: 100%;
      height: 180px;
      object-fit: cover;
      display: block;
    }

    .meta {
      padding: 12px;
      font-size: 14px;
    }

    .actions {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .icon-btn {
      padding: 6px;
      background: rgba(255,255,255,0.85);
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      border: 1px solid #ddd;
      transition: 0.2s;
    }
    .icon-btn:hover {
      background: #eee;
    }
  </style>
</head>

<body>

  <nav class="navbar">
    <h1>AmazeHeads â€“ Admin Dashboard</h1>
    <button id="logoutBtn" class="btn">Logout</button>
  </nav>

  <main class="container">

    <!-- FOLDER MANAGEMENT -->
    <section class="panel">
      <h2>Folders</h2>
      <div class="row">
        <input id="newFolderName" type="text" placeholder="Folder name..." />
        <button id="createFolderBtn" class="btn">Create</button>
      </div>
      <div id="foldersList" class="list"></div>
    </section>

    <!-- UPLOAD SECTION -->
    <section class="panel">
      <h2>Upload Media</h2>

      <select id="folderSelect"></select>

      <!-- DRAG AND DROP AREA -->
      <div id="dropZone">Drag & Drop files here</div>

      <input type="file" id="fileInput" multiple accept="image/*,video/*" />
      <button class="btn" id="uploadBtn">Upload Selected Files</button>

      <p id="uploadProgress"></p>
    </section>

    <!-- MEDIA GRID -->
    <section class="panel">
      <h2>Media</h2>
      <div id="mediaList"></div>
    </section>

  </main>

  <script type="module">
    import {
      auth, logout, subscribeFolders, subscribeMedia,
      createFolder, uploadMediaFile, deleteMediaItem,
      renameMedia, moveMedia
    } from "./helpers.js";

    /* --- PROTECT PAGE --- */
    auth.onAuthStateChanged(u => {
      if (!u) location.href = "admin-login.html";
    });

    /* --- ELEMENTS --- */
    const logoutBtn = document.getElementById("logoutBtn");
    const folderSelect = document.getElementById("folderSelect");
    const foldersList = document.getElementById("foldersList");
    const newFolderName = document.getElementById("newFolderName");
    const createFolderBtn = document.getElementById("createFolderBtn");

    const fileInput = document.getElementById("fileInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const uploadProgress = document.getElementById("uploadProgress");

    const dropZone = document.getElementById("dropZone");

    const mediaList = document.getElementById("mediaList");

    let currentFolderId = null;
    let folderCache = [];

    /* --- LOGOUT --- */
    logoutBtn.onclick = () => logout().then(() => location.href = "admin-login.html");

    /* --- RENDER FOLDERS --- */
    function renderFolders(folders) {
      folderCache = folders;
      folderSelect.innerHTML = `<option value="">Root Folder</option>`;
      folders.forEach(f => {
        const opt = document.createElement("option");
        opt.value = f.id;
        opt.textContent = f.name;
        folderSelect.appendChild(opt);
      });

      foldersList.innerHTML = "";
      const rootBtn = document.createElement("div");
      rootBtn.className = "list-item";
      rootBtn.textContent = "All Media";
      rootBtn.onclick = () => { currentFolderId = null; loadMedia(); };
      foldersList.appendChild(rootBtn);

      folders.forEach(f => {
        const el = document.createElement("div");
        el.className = "list-item";
        el.textContent = f.name;
        el.onclick = () => { currentFolderId = f.id; loadMedia(); };
        foldersList.appendChild(el);
      });
    }

    /* --- MODERN MEDIA GRID --- */
    function renderMedia(items) {
      mediaList.innerHTML = "";

      if (!items.length) {
        mediaList.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:#777;">No media found.</p>`;
        return;
      }

      items.forEach(item => {
        const card = document.createElement("div");
        card.className = "card";

        if (item.type === "video") {
          card.innerHTML = `<video src="${item.url}" controls></video>`;
        } else {
          card.innerHTML = `<img src="${item.url}" />`;
        }

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.innerHTML = `
          <strong>${item.name}</strong><br>
          <span>${new Date(item.createdAt?.seconds * 1000).toLocaleString()}</span>
        `;
        card.appendChild(meta);

        // ACTION BUTTONS
        const actions = document.createElement("div");
        actions.className = "actions";

        const del = document.createElement("button");
        del.className = "icon-btn";
        del.textContent = "ðŸ—‘";
        del.title = "Delete";
        del.onclick = () => { if (confirm("Delete this media?")) deleteMediaItem(item); };

        const ren = document.createElement("button");
        ren.className = "icon-btn";
        ren.textContent = "âœï¸";
        ren.title = "Rename";
        ren.onclick = () => {
          const newName = prompt("Enter new name:", item.name);
          if (newName) renameMedia(item.id, newName);
        };

        const mov = document.createElement("button");
        mov.className = "icon-btn";
        mov.textContent = "ðŸ“";
        mov.title = "Move to folder";
        mov.onclick = () => {
          const id = prompt("Enter target folder ID:");
          if (id) moveMedia(item.id, id);
        };

        actions.appendChild(ren);
        actions.appendChild(mov);
        actions.appendChild(del);

        card.appendChild(actions);
        mediaList.appendChild(card);
      });
    }

    /* --- CREATE FOLDER --- */
    createFolderBtn.onclick = () => {
      const name = newFolderName.value.trim();
      if (!name) return alert("Enter folder name");
      createFolder(name, auth.currentUser.email);
      newFolderName.value = "";
    };

    /* --- LOAD MEDIA --- */
    function loadMedia() { subscribeMedia(renderMedia, currentFolderId); }

    /* --- DRAG & DROP --- */
    dropZone.addEventListener("dragover", e => {
      e.preventDefault();
      dropZone.classList.add("dragover");
    });

    dropZone.addEventListener("dragleave", () => {
      dropZone.classList.remove("dragover");
    });

    dropZone.addEventListener("drop", e => {
      e.preventDefault();
      dropZone.classList.remove("dragover");
      fileInput.files = e.dataTransfer.files;
      alert(fileInput.files.length + " files added for upload");
    });

    /* --- BULK UPLOAD --- */
    uploadBtn.onclick = async () => {
      const files = [...fileInput.files];
      if (!files.length) return alert("Select or drop files first");

      const folderId = folderSelect.value || null;
      uploadProgress.textContent = "Uploading... 0%";

      uploadBtn.disabled = true;

      try {
        for (let i = 0; i < files.length; i++) {
          const f = files[i];

          uploadProgress.textContent = `Uploading ${i+1}/${files.length}...`;

          await uploadMediaFile(
            f,
            folderId,
            auth.currentUser.email,
            pct => uploadProgress.textContent = `Uploading ${i+1}/${files.length} â€“ ${pct}%`
          );
        }

        uploadProgress.textContent = "Upload completed!";
        fileInput.value = "";

      } catch (err) {
        alert("Upload error: " + err.message);
      }

      uploadBtn.disabled = false;
      setTimeout(() => uploadProgress.textContent = "", 2000);
    };

    /* --- LIVE UPDATES --- */
    subscribeFolders(renderFolders);
    loadMedia();

  </script>

</body>
</html>
